---
title: "Value Streams Graphs"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Loading Packages

The following code is used to upload the packages to allow for easy access to a range of useful functions.

```{r, message = FALSE, warning = FALSE, include = FALSE}
# Load the packages needed
library(dplyr)
library(stringr)
library(tidyr)

# Package for data viz
library(ggplot2)
library(ggthemes)
library(scales)
library(plotly)
```

## Setting Variables

Below are a set of inputs used throughout the analysis.

```{r}
# Setting the year, filepath, and separator (between benefit and year) 
years <- c("19_20", "20_21", "21_22", "22_23") # Add new years when data becomes available
filepath <- '/mnt/s3fs/s3-home/Value_Streams/Outputs'
sep <- "_"


# Setting the variables (taken from Python Model)
vs_list <- c('Advice & Guidance', 'Appeal Award', 'Complain About The Service', 'Corporate - Finance', 
           'Corporate - HR', 'Corporate - Other', 'Cost Only - Other', 'Costs Only - Employment Programme',
           'Costs Only - Medical Contracts', 'Costs Only - Pay Award', 'Estates', 'Fraud And Error',
           'IT and Digital', 'Improve Employability', 'Other', 'Pay Award', 'Processing', 'Recover Debt',
           'Telephony (Inbound)')

customer_vs_list <- c('Advice & Guidance', 'Benefit Claims Award', 'Review Award', 'Benefit Handling*', 'Appeal Award', 
                      'Pay Award', 'Improve Employability', 'Complain About The Service', 'Recover Debt', 'Fraud And Error',
                      'Other')

ben_list <- c('AA', 'CA', 'CMG', 'DLA', 'ESA', 'IS', 'JSA', 'Other', 'PC', 'PIP', 'SP', 'UC')

output_ben_order <- c("UC", "JSA", "IS", "PC", "SP", "AA", "ESA", "PIP", "DLA", "CA", "CMG", "Employment Programmes",
                        "Other Products")
```

## Data Loading & Processing

1.  Pulling data generated from the Python model and loading this into RStudio:

```{r}
# Creates an object names list to allow for easier loading of data
object_names_list = list()

for (year in years){
  object_names_list[[year]] <- str_c(ben_list, sep, year)
}


# Loads the csv files generated by the Python model and stores them in RStudio
for (year in years){
  for (ben in object_names_list[[year]]){
    assign(ben, read.csv(str_c(filepath, "/", year, "/", ben, ".csv"), stringsAsFactors = F))
  }
}
```

2.  Combining all the loaded spreadsheets into one big table called combined_table. Before we combine the spreadsheets, we need to add columns for year and benefit to distinguish the data when combined.

```{r}
# Adds columns for year and benefit to each table
for (year in years){
  for (i in 1:length(ben_list)){
   assign(object_names_list[[year]][i], 
          get(object_names_list[[year]][i]) %>% 
            mutate(Benefit = ben_list[i], Year = str_replace_all(year, sep, "/")))
  }
}
```

```{r}
# Combines all the spreadsheets into combined_table
combined_table <- data.frame()

for (year in years){
  for (i in 1:length(ben_list)){
    combined_table <- rbind(combined_table, get(object_names_list[[year]][i]), stringsAsFactors = FALSE)
  }
}
```

3.  Loads the 18/19 data and then combines it with combined_table:

```{r}
# Loads the 18/19 summary costs separately as this data is stored separately
data_18_19 <- readxl::read_xlsx(str_c(filepath, "/18_19 Data.xlsx"))

# Prepares the data to be merged with combined_table
data_18_19 <- data_18_19 %>%
  rename(Processing = `Benefit Handling*`) %>%
  gather(key = "Category", value = "Total", 2:ncol(data_18_19)) %>%
   # adds dummy Staff and Non-Staff Costs for now
  mutate(Staff_Costs = 0, Non_Staff_Costs = 0, Year = "18/19") %>%
  rename(Benefit = `DWP Product`) %>%
  # selects columns in same order as combined_table
  select(Category, Staff_Costs, Non_Staff_Costs, Total, Benefit, Year) %>%
  # Arranges variables by benefit then category like how it's done for combined_table
  arrange(Benefit, Category)


# Combines 18/19 data with the rest of the data
combined_table <- rbind(data_18_19, combined_table)
```

4.  Loads the Employment Programmes data and then combines it with combined_table:

```{r}
# Loads the Employment Programmes Data as this is not in Python output csvs
data_employment_prog <- readxl::read_xlsx(str_c(filepath, "/Employment Programmes.xlsx"))


# Combines Employment programmes data the with rest of the data
combined_table <- rbind(combined_table, data_employment_prog) %>%
  arrange(Year, Benefit)
```

```{r}
# Creates new fiscal_year_start column in a numeric format
combined_table <- combined_table %>% 
  mutate(fiscal_year_start = as.numeric(str_c("20", str_sub(Year, 1, 2))))
```

## Temporary Code

1.  Renames the VS category "Processing" to "Benefit Handling\*" and the product "Other" to "Other Products".

```{r}
# renames "Processing" to "Benefit Handling*"
combined_table$Category[combined_table$Category == "Processing"] <- "Benefit Handling*"

# renames "Other" to "Other Products"
combined_table$Benefit[combined_table$Benefit == "Other"] <- "Other Products"
```

2.  Reassigns Benefit Claims and Review Award to Benefit Handling\* for "Other Products".

```{=html}
<!-- -->
```
a)  Firstly, we create a data frame 'Other_Handling' which combines the "Benefit Handling\*","Review Award" and "Benefit Claims Award" costs when the benefit is "Other Products". We do this because the data doesn't give us an accurate split of these costs when it comes to Other Products.

```{r}
Other_Handling <- combined_table %>%
  # Selects rows where benefit is Other products AND Category is either Ben Handling*, Review Award, or Ben Claims Award
  # Change the categories listed below if future value streams change
  filter(Benefit == "Other Products" & 
           Category %in% c("Benefit Handling*", "Review Award", "Benefit Claims Award")) %>%
  # Combines these costs into one row which has Benefit set as Other Products and Category set as Benefit Handling*
  # Change the Benefit / Category name set below if needed
  group_by(fiscal_year_start, Year) %>%
  summarise(Benefit = "Other Products", Category = "Benefit Handling*", Staff_Costs = sum(Staff_Costs), 
            Non_Staff_Costs = sum(Non_Staff_Costs), Total = sum(Total)) %>%
  ungroup()
```

b)  In the next step, we combine the 'Other_Handling' data frame we produced to the original 'combined_table'. However, we must first filter our rows where Benefit is "Other Products" and category is either "Benefit Handling", "Review Award", or "Benefit Claims Award", as the combination of these rows is represented in 'Other_Handling'.

```{r}
combined_table <- combined_table %>%
  # selects every row except for when Benefit is Other Products and Category is either Benefit Handling*, Review 
  # Award, or Benefit Claims Award, to prevent double counting since these rows are represented in Other_Handling.
  # Edit the categories if needed
  filter(!(Benefit == "Other Products" & 
           Category %in% c("Benefit Handling*", "Review Award", "Benefit Claims Award"))) %>%
  # Combines Other_Handling with this selection of data
  bind_rows(Other_Handling) %>%
  arrange(Benefit, fiscal_year_start, Category)
```

## Data Visualisations

1.  Value Streams and Benefit Costs breakdown table

```{r}
# Filters the data to use data for latest year
# Filters data to include vs categories relating to customer journey only
# Selects the Benefit, Category and Total columns only
output_table <- combined_table %>%
  filter(fiscal_year_start == max(fiscal_year_start)) %>%
  filter(Category %in% customer_vs_list) %>%
  select(Benefit, Category, Total)

# Orders Category by the order used in customer_vs_list
# Orders Benefit by the order used in output_table_order
output_table <- transform(output_table, 
                          Category = factor(Category, levels = customer_vs_list),
                          Benefit = factor(Benefit, levels = output_ben_order))

# Produces output table then saves 
output_table <- output_table %>%
  arrange(Category) %>%
  spread(key = Category, value = Total) %>%
  arrange(Benefit)

# Writes a directory to save the Output table in
dir.create(str_c(filepath, "/Graphs"))

# Saves the output table as a csv
write.csv(output_table, file = str_c(filepath, "/Graphs/", tail(years, 1), " Output Table.csv"), row.names = FALSE)


```

2.  Value Stream Line chart Overview

Data preparation:

```{r}
# Filters data to include vs categories relating to customer journey
# Sums costs for each of these categories for each year
line_chart_data <- combined_table %>% 
  select(Category, Total, Year, fiscal_year_start) %>% 
  filter(Category %in% customer_vs_list) %>%
  group_by(Category, fiscal_year_start, Year) %>%
  summarise(Costs = sum(Total)) %>%
  ungroup()

# Creates Total Costs as a category so that we can see how VS costs has changed versus overall costs
line_chart_data <- rbind(line_chart_data,  
      line_chart_data %>% 
        group_by(fiscal_year_start, Year) %>% 
        summarise(Category = "Total", Costs = sum(Costs)) %>%
        ungroup()
)

# Creates a new column filled with the base year cost for each value stream
line_chart_data <- line_chart_data %>%
  left_join(
line_chart_data %>%
  filter(fiscal_year_start == min(fiscal_year_start)) %>%
  select(Category, Costs) %>%
  rename(base_cost = Costs),
by = "Category")

# Uses this base year cost to find the proportional costs increase from the base year
# Base year proportional change is therefore set to 0
line_chart_data <- line_chart_data %>%
  mutate(cost_increase_prop = Costs/base_cost - 1)

# Orders Categories by customer_vs_list
line_chart_data <- transform(line_chart_data, 
                          Category = factor(Category, levels = c("Total", customer_vs_list)))

# Duplicates the Category columnn to prepare for line chart
line_chart_data <- line_chart_data %>%
  mutate(Category2 = Category)
```

Creates the line plot with customisations:

```{r}
# Plots the data
line_chart_data %>%
  ggplot( aes(x=fiscal_year_start, y=cost_increase_prop)) +
    geom_line( data=line_chart_data %>% dplyr::select(-Category), aes(group=Category2), color="grey", size=0.5, alpha=0.5) +
    geom_line( aes(color=Category), color="#00325C", size=1.2 ) +
    theme_clean() +
    theme(
      # The text arguments changes the format of the text in the plot
      text = element_text(size = 13, family = "Arial", face = "bold"),
      axis.text.x = element_text(size = 11, family = "Arial"),
      axis.text.y = element_text(size = 11, family = "Arial"),
      axis.line = element_blank(),
      legend.position="none", # removes legend
      panel.border = element_blank(), # removes the border in the plot
      panel.spacing = unit(1.5, "lines"),
      # plot.background and panel.background arguments makes our background transparent
      plot.background = element_rect(fill = "transparent", colour = NA),
      panel.background = element_rect(fill = "transparent", colour = NA),
      axis.ticks = element_blank() # removes axis ticks
    ) +
    labs(x = "", y = "") +
  # The following code edits the numerical format of the y-axis and expands the x-axis
    scale_y_continuous(labels = percent,
                       breaks = seq(round(min(line_chart_data$cost_increase_prop/0.5)*0.5),
                                    round(max(line_chart_data$cost_increase_prop/0.5)*0.5), 0.5)) +
    scale_x_continuous(expand = expansion(mult = c(0, 0.05), add = c(0, 0.75)), 
                       breaks = seq(min(line_chart_data$fiscal_year_start), max(line_chart_data$fiscal_year_start), 1), 
                       labels = unique(combined_table$Year)) +
    facet_wrap(~Category) +
  # The following code adds the labels for the % change in spend
    geom_text(data=subset(line_chart_data, fiscal_year_start == max(fiscal_year_start)), hjust = -0.15, 
              aes(label = str_c(formatC(cost_increase_prop*100, format ="f", flag = "+", digits = 0), "%"),
                  fontface = "bold"), size = 4.2, family = "Arial")

# Uses ggsave to save the outputs to a png
ggsave(filename = str_c(filepath, "/Graphs/VS_View.png"), width = 14, height = 7, units = "in", dpi=300)

```

The following figures produced in the code chunk below can be used for potential labels:

```{r}
# Prints out the changes in the last year 
# This can be used for Ppt captions if you exclude the geom_text line in the above code
line_chart_data %>%
  filter(fiscal_year_start == max(fiscal_year_start)) %>%
  mutate(percent_change = round(cost_increase_prop * 100)) %>%
  select(Category, percent_change)

```

3.  Dumbbell chart Data Preparation:

```{r}
# Filters data to include vs categories relating to customer journey
# Sums costs by value stream category and by year
dumbbell_data <- combined_table %>% 
  select(Category, Total, Year, fiscal_year_start) %>% 
  filter(Category %in% customer_vs_list) %>%
  group_by(Category, fiscal_year_start, Year) %>%
  summarise(Spend = sum(Total)) %>%
  ungroup()

# Filters out data to take earliest and latest year only, then creates variables needed for dumbell chart
dumbbell_data <- dumbbell_data %>% 
  filter(fiscal_year_start == min(fiscal_year_start) | fiscal_year_start == max(fiscal_year_start)) %>%
  mutate(paired = rep(1:(n()/2), each = 2),
         Year = factor(Year))

# Orders Categories by customer_vs_list
dumbbell_data <- transform(dumbbell_data, 
                          Category = factor(Category, levels = customer_vs_list[length(customer_vs_list):1]))
```

Creates the base dumbbell plot:

```{r}
dumbbell_plot <- dumbbell_data %>%
  ggplot(aes(x = Spend, y = Category)) +
  geom_line(aes(group = paired), colour = "#A6A6A6") +
  geom_point(aes(color = Year), size = 4) +
  theme(legend.position = "top")

dumbbell_plot
```

Edits the presentation of the chart:

```{r}
# Making adjustments to the dumbell plot
dumbbell_plot + 
  xlab("DEL Spend by Value Stream (£m)") +
  ylab("") +
  theme_few() + # Changes the theme of presentation
  scale_colour_manual(labels = c(str_c(head(unique(combined_table$Year), 1), "    "),
                                 tail(unique(combined_table$Year), 1)), 
                      values = c("#E05206", "#00325C")) + # Changes colour of points to fit DWP theme
  scale_x_continuous(labels = scales::unit_format(scale = 1e-6, prefix = "£", suffix = "m", big.mark = ","),
                     breaks = seq(0, max(dumbbell_data$Spend) + 200e6, 200e6),  # Change limit size of x axis here
                     expand = expansion(mult = c(0,0), add = c(50e6, 200e6))) +
  scale_y_discrete(expand = expansion(mult = c(0, 0), add = c(0.5, 0.6))) +
  # Following code formats the text of the x-axis and the y-axis
  theme(axis.title.x = element_text(face = "bold", colour = "#757171", family = "Arial", size = 10,
                                    margin = unit(c(5, 0, 0, 0), "mm")), 
        axis.text.y = element_text(face = "bold", colour = "#262626", family = "Arial"),
        # Adds major gridlines for the x-axis
        panel.grid.major.x = element_line(colour = "grey",
                                          size = 0.25,
                                          linetype = "solid"),
        # Following code formats the legend in multiple ways, makes our diagram background transparent, removes axes ticks
        legend.position = "top",
        legend.direction = "horizontal",
        legend.title = element_blank(),
        legend.spacing.x = unit(0.05, "cm"),
        legend.background = element_blank(),
        legend.key = element_rect(fill = "transparent"),
        panel.border = element_blank(),
        plot.background = element_rect(fill = "transparent", colour = NA),
        panel.background = element_rect(fill = "transparent", colour = NA),
        axis.ticks = element_blank()) 


# Saves the dumbbell plot
ggsave(filename = str_c(filepath, "/Graphs/VS_Dumbbell.png"), width = 28, height = 14, units = "cm", dpi=300)
```

The dumbbell plot needs labels to show how much spend has changed from 18/19 to the latest fiscal year. The code chunk below produces these figures:

```{r}
# Calculates the difference in spend on each vs category between the years
dumbbell_labels <- dumbbell_data %>%
  arrange(desc(Category), fiscal_year_start) %>%
  group_by(Category) %>%
  mutate(Spend_diff = Spend[2] - Spend[1]) %>%
  filter(fiscal_year_start == max(fiscal_year_start)) %>%
  select(Category, Spend_diff)

# Prints out the differences to be used for labelling
dumbbell_labels$Spend_diff = str_c(formatC(dumbbell_labels$Spend_diff/1e6, format = "f", digits = 0, flag = "+"), "m")
print(dumbbell_labels)
```

4.  Bar Chart to Explain Increase in Improve Employability

This chart may need updating if the value stream categories change or if you would like to compare spending for a different value stream. Update the line "filter(Category) =="Improve Employability" to do this. You will also need to update the line "mutate(Change = `22/23` - `18/19`," when the years being used have changed.

Creating the base data:

```{r}
employ_bar_data <- combined_table %>%
  # Filters out data relating to "Improve Employability" for 18/19 and the latest year available
  filter(Category == "Improve Employability", # Update this line if there is a different VS of interest
         fiscal_year_start %in% c(min(fiscal_year_start), max(fiscal_year_start))) %>%
  select(Category, Benefit, Total, Year) %>%
  spread(key = Year, value = Total) %>%
  # Creates a column to calculate change in spend between latest year and base year
  # Also creates a column that is labelled "Positive" or "Negative" based on the 'Change' value
  mutate(Change = `22/23` - `18/19`, # Update the latest years being used here
         change_direction = case_when(
    Change < 0 ~ "Negative",
    Change > 0 ~ "Positive",
    TRUE ~ "No Change"
  )) %>%
  # Filters out benefits that have small changes as these do not contribute to the analysis
  filter(abs(Change) > 1e6)
```

Creating the plot:

```{r}
# Plots the data
employ_bar_data %>%
  ggplot(aes(x = stringr::str_wrap(Benefit, 10), y = Change, fill = change_direction)) +
  # Sets DWP theme colours
  scale_fill_manual(values = c("#E05206", "#00325C")) +
  geom_bar(stat = "identity", width = 0.4) +
  # Editing general theme and presentation of axes
  labs(x = "", y = "") +
  scale_y_continuous(breaks = seq(floor(min(employ_bar_data$Change/1e8))*1e8, 
                                  ceiling(max(employ_bar_data$Change/1e8))*1e8, 1e8),
                     labels = unit_format(scale = 1e-6, prefix = "£", suffix = "m")) +
  
  theme_few() +
  # Makes the diagram background transparent, removes axes ticks, adds y-axis major gridlines, removes legend
  theme(panel.border = element_blank(),
        plot.background = element_rect(fill = "transparent", colour = NA),
        panel.background = element_rect(fill = "transparent", colour = NA),
        axis.ticks = element_blank(),
        panel.grid.major.y = element_line(colour = "grey", size = 0.25),
        legend.position = "none")

# Saves the plot  
ggsave(filename = str_c(filepath, "/Graphs/Improve_Employability_Bar.png"), width=20, height=11, units="cm", dpi=300)  
```

5.  Bar Chart comparing Spending between 18/19 and latest fiscal year for all benefits Data Preparation:

```{r}
# Filters data to include vs categories relating to customer journey
# Sums costs by benefit and by year
bar_data <- combined_table %>%
  filter(Category %in% customer_vs_list) %>%
  group_by(Benefit, fiscal_year_start, Year) %>%
  summarise(Total_Costs = sum(Total)) %>%
  ungroup() %>%
  filter(fiscal_year_start %in% c(min(fiscal_year_start), max(fiscal_year_start)))

# Arranges the benefits to be ordered based on output_ben_order
bar_data <- transform(bar_data, Benefit = factor(Benefit, levels = output_ben_order))

```

Creates base bar plot:

```{r}
bar_plot <- bar_data %>%
  ggplot(aes(x = Benefit, y = Total_Costs, fill = Year)) +
  geom_bar(position = "dodge", stat = "identity", width = 0.7)

bar_plot
```

Adds customisations to the base bar plot:

```{r}
bar_plot +
  # Removes axes titles
  labs(x = "", y = "") +
  # Incorporates DWP theme colours and uses the latest year and oldest year as the legend
  scale_fill_manual(labels = c(str_c(head(unique(combined_table$Year), 1), "    "),
                               tail(unique(combined_table$Year), 1)),
                    values = c("#E05206", "#00325C")) + 
  # Edits general presentation of the chart
  theme_few() +
  theme(panel.border = element_blank(), 
        panel.grid.major.y = element_line(colour = "grey", size = 0.25), # Adds major gridlines for y-axis
        axis.text.x = element_text(family = "Arial", size = 8.5), # Edits the x-axis text formats
        axis.ticks = element_blank()) +
  # Sets the limits of the y-axis
  scale_y_continuous(breaks = seq(0, max(bar_data$Total_Costs) + 200e6, 200e6),
                     labels = scales::unit_format(scale = 1e-6, prefix = "£", suffix = "m", big.mark = ","),
                     expand = expansion(mult = c(0, 0), add = c(0, 200e6))) +
  # Makes various edits to the legend and makes the diagram background transparent
  theme(legend.position = "bottom",
        legend.background = element_blank(),
        legend.title = element_blank(),
        legend.key.size = unit(1.3, "line"),
        legend.margin = margin(0, 0, 0, 0), 
        legend.box.spacing = unit(0, "pt"),
        legend.box.margin = margin(-10, -10, -10, -10),
        plot.background = element_rect(fill = "transparent", colour = NA),
        panel.background = element_rect(fill = "transparent", colour = NA)) +
  # Makes the x-axis labels be able to wrap so that it takes less space
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) 

# Saves the plot as a png file
ggsave(filename = str_c(filepath, "/Graphs/VS_Bar.png"), width = 26, height = 14.5, units = "cm", dpi=300)
```

6.  Line chart comparing UC with other employment benefits (May need updating)

The data preparation steps are shown below. To edit the benefits used to compare, edit the second chunk of code.

```{r}
# Filters data to include vs categories relating to customer journey
# Sums costs by benefit and by year
UC_line_data <- combined_table %>%
  filter(Category %in% customer_vs_list) %>%
  group_by(Benefit, fiscal_year_start, Year) %>%
  summarise(Total_Costs = sum(Total)) %>%
  ungroup() 
```

Edit below if different benefits to ESA/JSA/IS are used to compare:

```{r}
# Sums the spend on the benefits ESA/JSA/IS to contain it as one benefit
ESA_JSA_IS <- UC_line_data %>% 
  filter(Benefit %in% c("ESA", "JSA", "IS")) %>% # Remember to edit the benefits filtered as well!
  group_by(fiscal_year_start, Year) %>%
  summarise(Total_Costs = sum(Total_Costs)) %>%
  mutate(Benefit = "ESA/IS/JSA") %>% # Edit this line of code to name the benefits you're comparing
  ungroup()
```

Edit below as necessary as well:

```{r}
# Combines rows for ESA/IS/JSA spend with UC spend
UC_line_data <- rbind(filter(UC_line_data, Benefit == "UC"), ESA_JSA_IS) # Edit here if different benefit are used

# Calculates the total spend on UC & ESA/JSA/IS
# Binds this Total spend on UC/ESA/IS/JSA to the data
UC_line_data <- rbind(UC_line_data, 
                      UC_line_data %>%
                        group_by(fiscal_year_start, Year) %>%
                        summarise(Total_Costs = sum(Total_Costs)) %>%
                        mutate(Benefit = "Total") %>%
                        ungroup())
```

Creating the base line chart comparing spend in UC vs ESA, IS, JSA combined:

```{r}
# Creates the plot, setting the line and point size
UC_plot <- UC_line_data %>%
  ggplot(aes(x = fiscal_year_start, y = Total_Costs, colour = Benefit)) +
  geom_line(size = 1.2) +
  geom_point(size = 1.5)

UC_plot
```

Adding customisations to the plot:

```{r}
UC_plot +
  theme_few() +
  # Changes the colours used to fit DWP theme
  scale_colour_manual(values = c("#F2B696", "#00325C", "#E05206")) +
  # Formats the axes, y-axis gridlines, axis text
  theme(axis.title = element_blank(),
        panel.grid.major.y = element_line(colour = "grey", size = 0.25),
        panel.grid.minor.y = element_line(colour = "grey", size = 0.1),
        panel.border = element_blank(),
        plot.background = element_rect(fill = "transparent", colour = NA),
        panel.background = element_rect(fill = "transparent", colour = NA),
        axis.ticks.length.y = unit(0.3, "cm"),
        axis.ticks = element_blank(),
        axis.text.x = element_text(hjust = 0.2),
        # Removes legend
        legend.position = "none") +
  # Formats the y-axis limits and the numerical format
  scale_y_continuous(breaks = seq(0, max(UC_line_data$Total_Costs) + 200e6, 400e6), 
                     labels = scales::unit_format(scale = 1e-6, prefix = "£", suffix = "m", big.mark = ","),
                     expand = expansion(mult = c(0,0), add = c(min(UC_line_data$Total_Costs), 200e6))) + 
  # Formats the x-axis limits and expands the x-axis
  scale_x_continuous(labels = unique(UC_line_data$Year),
                     breaks = seq(min(UC_line_data$fiscal_year_start), max(UC_line_data$fiscal_year_start), 1),
                     expand = expansion(mult = c(0,0), add = c(0, 0.8))) +
  # Adds labels to the plot to distinguish which line refers to which benefit
  geom_text(data=subset(UC_line_data, fiscal_year_start == max(fiscal_year_start)),
            aes(label = Benefit), hjust = -0.2, fontface = "bold")

# Saves the plot in a png format
ggsave(filename = str_c(filepath, "/Graphs/VS_UC_Legacy_line.png"), width = 26, height = 13, units = "cm", dpi=300)
```

6.  Bar Chart comparing spend between "Benefit Handling\*" and "Benefit Claims Award" and "Review Award" (May need updating)

The code chunks below show the data processing steps. Edit the first chunk if different vs categories are used. The second data processing code chunk should not need updating.

```{r}
# Sums costs by vs category and by year
UC_bar_data <- combined_table %>%
  group_by(Category, fiscal_year_start, Year) %>%
  summarise(Costs = sum(Total)) %>%
  ungroup() %>%
  # Filters the categories included in analysis. EDIT BELOW IF VS CATEGORIES CHANGE
  filter(Category %in% c("Benefit Handling*", "Review Award", "Benefit Claims Award")) 
```

```{r}
# Sets an index so that we can arrange the position of the bars
UC_bar_data <- UC_bar_data %>%
  mutate(index = case_when(
    Category == "Benefit Claims Award" ~ 1,
    Category == "Review Award" ~ 2,
    Category == "Benefit Handling*" ~ 3
  ))

# Calculates a column for combined costs and cumulative costs
# Cumulative costs are used to position the labels in the plot later
UC_bar_data <- UC_bar_data %>%
  arrange(fiscal_year_start, desc(index)) %>%
  group_by(fiscal_year_start, Year) %>%
  mutate(Combined_Costs = sum(Costs),
         Cumulative_Costs = cumsum(Costs)) %>%
  ungroup() 
```

Creates a base version of the bar chart:

```{r}
UC_bar_plot <- UC_bar_data %>%
  ggplot(aes(x = Year, y = Costs, fill = reorder(Category, index))) +
  geom_bar(stat = "identity", position = "stack", width = 0.7)

UC_bar_plot
```

Adds customisations to the bar chart:

```{r}
UC_bar_plot +
  theme_few() +
  # Incorporates DWP theme colours
  scale_fill_manual(values = c("#00325C", "#4A6798", "#E05206")) + 
  # Removes axes labels
  labs(x = "", y = "") +
  # Edits the limits and numerical format of the y-axis
  scale_y_continuous(labels = scales::unit_format(scale = 1e-6, big.mark = ",", prefix = "£", suffix = "m"),
                     breaks = seq(0, max(UC_bar_data$Combined_Costs) + 200e6, 200e6),
                     expand = expansion(mult = c(0,0), add = c(0, 200e6))) +
  # Adds labels for the spend for each value stream category (i.e. Benefit Claims, Review, Benefit Handling)
  geom_text(aes(x = Year, y = Cumulative_Costs,
                label = scales::comma(Costs, scale = 1e-6, prefix = "£", suffix = "m", accuracy = 1)),
            vjust = 2, colour = "#FFFFFF", family = "Calibri", fontface = "bold") +
  # Removes panel border and axis ticks, adds y-axis major gridlines, edits legend position
  theme(panel.border = element_blank(),
        axis.ticks = element_blank(),
        panel.grid.major.y = element_line(colour = "grey", size = 0.2),
        plot.background = element_rect(fill = "transparent", colour = NA),
        panel.background = element_rect(fill = "transparent", colour = NA),
        legend.position = "bottom",
        legend.title = element_blank(),
        legend.margin = margin(0, 0, 0, 0), 
        legend.box.spacing = margin(0.5))

# Saves the chart in a png format
ggsave(filename = str_c(filepath, "/Graphs/Benefit_Handling_Bar.png"), width = 23, height = 13.1, units = "cm", dpi=300)
```

6b. Bar Chart comparing spend between "Benefit Handling\*" and "Benefit Claims Award" and "Review Award" (May need updating)

The code chunks below show the data processing steps. Edit the first chunk if different vs categories are used. The second data processing code chunk should not need updating.

```{r}
# Sums costs by vs category and by year
UC_bar_data <- combined_table %>%
  filter(Benefit %in% c("UC", "JSA", "ESA", "IS")) %>%
  group_by(Category, fiscal_year_start, Year) %>%
  summarise(Costs = sum(Total)) %>%
  ungroup() %>%
  # Filters the categories included in analysis. EDIT BELOW IF VS CATEGORIES CHANGE
  filter(Category %in% c("Benefit Handling*", "Review Award", "Benefit Claims Award")) 
```

```{r}
# Sets an index so that we can arrange the position of the bars
UC_bar_data <- UC_bar_data %>%
  mutate(index = case_when(
    Category == "Benefit Claims Award" ~ 1,
    Category == "Review Award" ~ 2,
    Category == "Benefit Handling*" ~ 3
  ))

# Calculates a column for combined costs and cumulative costs
UC_bar_data <- UC_bar_data %>%
  arrange(fiscal_year_start, desc(index)) %>%
  group_by(fiscal_year_start, Year) %>%
  mutate(Combined_Costs = sum(Costs),
         Cumulative_Costs = cumsum(Costs)) %>%
  ungroup() 

# Creates a column for Cumulative Costs - (Costs/2) which is used for positioning the label
UC_bar_data <- UC_bar_data %>%
  mutate(text_position = Cumulative_Costs - Costs/2)
```

Creates a base version of the bar chart:

```{r}
UC_bar_plot <- UC_bar_data %>%
  ggplot(aes(x = Year, y = Costs, fill = reorder(Category, index))) +
  geom_bar(stat = "identity", position = "stack", width = 0.5)

UC_bar_plot
```

Adds customisations to the bar chart:

```{r}
UC_bar_plot +
  theme_few() +
  # Incorporates DWP theme colours
  scale_fill_manual(values = c("#00325C", "#4A6798", "#E05206")) + 
  # Removes axes labels
  labs(x = "", y = "") +
  # Edits the limits and numerical format of the y-axis
  scale_y_continuous(labels = scales::unit_format(scale = 1e-6, big.mark = ",", prefix = "£", suffix = "m"),
                     breaks = seq(0, max(UC_bar_data$Combined_Costs) + 200e6, 200e6),
                     expand = expansion(mult = c(0,0), add = c(0, 200e6))) +
  # Adds labels for the spend for each value stream category (i.e. Benefit Claims, Review, Benefit Handling)
  geom_text(aes(x = Year, y = text_position,
                label = scales::comma(Costs, scale = 1e-6, prefix = "£", suffix = "m", accuracy = 1)),
            colour = "#FFFFFF", family = "Calibri", fontface = "bold", size = 2.8) +
  # Removes panel border and axis ticks, adds y-axis major gridlines, edits legend position
  theme(panel.border = element_blank(),
        plot.background = element_rect(fill = "transparent", colour = NA),
        panel.background = element_rect(fill = "transparent", colour = NA),
        axis.ticks = element_blank(),
        panel.grid.major.y = element_line(colour = "grey", size = 0.2),
        panel.grid.minor.y = element_line(colour = "grey", size = 0.1),
        legend.position = "bottom",
        legend.title = element_blank(),
        legend.margin = margin(0, 0, 0, 0), 
        legend.box.spacing = margin(0.5))

# Saves the chart in a png format
ggsave(filename = str_c(filepath, "/Graphs/Benefit_Handling_Bar2.png"), width = 19, height = 11, units = "cm", dpi=300)
```

7.  Line charts for Appendix 2: Value Stream Categories

```{r}
# Writes a function to plot a line chart for a value stream
# A function allows plot customisations (e.g. axis limits) to be made based on a value stream's unique values

VS_appendix <- function(value_stream){
  # Filters data so that only value stream categories relating to customer journey is included
  # Sums spend by category and by year
  VS_line_data <- combined_table %>%
    filter(Category %in% customer_vs_list) %>%
    group_by(Category, fiscal_year_start, Year) %>%
    summarise(Total = sum(Total)) %>%
    ungroup() %>%
    filter(Category == value_stream)

  # Plots the line chart for the value_stream argument given
  VS_line_data %>% 
    ggplot(aes(x = fiscal_year_start, y = Total)) + 
    # Creates line and label points while incorporating DWP theme colour
    geom_line(size = 1.2, colour = "#00325C") + 
    geom_point(size = 1.5, colour = "#00325C") +
    # Edits the x-axis labels
    scale_x_continuous(labels = VS_line_data$Year) +
    # Edits numerical format of y-axis and the y-axis limits
    scale_y_continuous(expand = expansion(mult = c(0,0), add = c(min(VS_line_data$Total), max(VS_line_data$Total)/5)),
                       labels = scales::unit_format(scale = 1e-6, prefix = "£", suffix = "m", big.mark = ",")) +
    # removes axes labels
    labs(x = "", y = "") +
    theme_few() +
    # Adds major and minor y-axis gridlines and removes axes ticks
    theme(panel.grid.major.y = element_line(colour = "grey", size = 0.3),
          panel.grid.minor.y = element_line(colour = "grey", size = 0.1),
          panel.border = element_blank(),
          axis.ticks = element_blank())
}
```

```{r}
# Runs a for loop to plot the line chart for each value stream and then saves it
for (vs in customer_vs_list){
  VS_appendix(vs)
  ggsave(filename = str_c(filepath, "/Graphs/VS Appendix/", vs, " Line Chart.png"), 
         width = 25.5, height = 14.5, units = "cm", dpi = 300)
}
```

8.  Line charts for Appendix 3: Benefits

```{r}
# Writes a function to plot a line chart for a value stream
# A function allows plot customisations (e.g. axis limits) to be made based on a value stream's unique values

benefit_appendix <- function(ben){
  # Filters data so that only value stream categories relating to customer journey is included
  # Sums spend by benefit and by year
  ben_line_data <- combined_table %>%
    filter(Category %in% customer_vs_list) %>%
    group_by(Benefit, fiscal_year_start, Year) %>%
    summarise(Total = sum(Total)) %>%
    ungroup() %>%
    filter(Benefit == ben)

  # Plots the line chart for the ben argument given
  ben_line_data %>% 
    ggplot(aes(x = fiscal_year_start, y = Total)) + 
    # Creates line and points while incorporating DWP colour
    geom_line(size = 1.2, colour = "#00325C") + 
    geom_point(size = 1.5, colour = "#00325C") +
    # Edits the x-axis labels
    scale_x_continuous(labels = ben_line_data$Year) +
    # Edits the y-axis numerical format and limits
    scale_y_continuous(expand = expansion(mult = c(0,0), add = c(min(ben_line_data$Total), max(ben_line_data$Total)/5)),
                       labels = scales::unit_format(scale = 1e-6, prefix = "£", suffix = "m", big.mark = ",")) +
    # Removes axes labels
    labs(x = "", y = "") +
    theme_few() +
    # Adds major and minor gridlines for the y-axis
    theme(panel.grid.major.y = element_line(colour = "grey", size = 0.3),
          panel.grid.minor.y = element_line(colour = "grey", size = 0.1),
          # Removes panel border and axes ticks
          panel.border = element_blank(),
          axis.ticks = element_blank())
}
```

```{r}
# Runs a for loop to plot the line chart for each benefit and then save it
# We need to use the replace function to get the "Other Products" as this is saved originally as "Other"

for (ben in replace(ben_list, ben_list == "Other", "Other Products")){
benefit_appendix(ben)
ggsave(filename = str_c(filepath, "/Graphs/Benefit Appendix/", ben, " Line Chart.png"), 
       width = 25.5, height = 14.5, units = "cm", dpi = 300)
}
```
